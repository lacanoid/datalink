\pset null _null_
SET client_min_messages = notice;
SET search_path = public,datalink;
create table sample_datalinks2 (
  id serial,
  link datalink
);
NOTICE:  DATALINK DDL: CREATE TRIGGER "~RI_DatalinkTrigger" BEFORE INSERT OR UPDATE OR DELETE ON sample_datalinks2 FOR EACH ROW EXECUTE PROCEDURE datalink.dl_ri_trigger()
select dl_chattr('public','sample_datalinks2','link', dl_lco(link_control=>'FILE',integrity=>'SELECTIVE'));
 dl_chattr 
-----------
        17
(1 row)

select sql_identifier,lco,dlco.*
  from datalink.dl_columns left join datalink.dl_link_control_options dlco using (lco);
         sql_identifier         | lco | lco | link_control | integrity | read_access | write_access | recovery | on_unlink 
--------------------------------+-----+-----+--------------+-----------+-------------+--------------+----------+-----------
 datalink.sample_datalinks.link |  17 |  17 | FILE         | SELECTIVE | FS          | FS           | NO       | NONE
 sample_datalinks.link          |   0 |   0 | NO           | NONE      | FS          | FS           | NO       | NONE
 sample_datalinks2.link         |  17 |  17 | FILE         | SELECTIVE | FS          | FS           | NO       | NONE
(3 rows)

/*
insert into sample_datalinks2 (link)
values (dlvalue('http://en.wikipedia.org','URL','Sample datalink'));
*/
insert into sample_datalinks2 (link)
values (dlvalue('/etc/','FS','Sample file datalink'));
NOTICE:  DATALINK: dl_ref('file:///etc/',17,sample_datalinks2,link)
insert into sample_datalinks2 (link)
values (dlvalue('file:///foo+bar/no_file','URL','Sample file datalink 2'));
NOTICE:  DATALINK: dl_ref('file:///foo+bar/no_file',17,sample_datalinks2,link)
ERROR:  Referenced file does not exit
DETAIL:  [sample_datalinks2.link] file:///foo+bar/no_file
CONTEXT:  PL/pgSQL function dl_ref(datalink,dl_lco,regclass,name) line 19 at RAISE
PL/pgSQL function dl_ri_trigger() line 38 at assignment
select dl_chattr('public','sample_datalinks2','link', dl_lco(link_control=>'FILE'));
ERROR:  Can't change link control options; 1 non-null values present in column "link"
CONTEXT:  PL/pgSQL function dl_chattr(name,name,name,dl_lco) line 22 at RAISE
insert into sample_datalinks2 (link)
values (dlvalue('https://www.debian.org','URL','Sample HTTPS datalink'));
NOTICE:  DATALINK: dl_ref('https://www.debian.org',17,sample_datalinks2,link)
insert into sample_datalinks2 (link)
values (dlvalue('http://blah','URL','Broken datalink'));
NOTICE:  DATALINK: dl_ref('http://blah',17,sample_datalinks2,link)
ERROR:  Referenced file does not exit
DETAIL:  [sample_datalinks2.link] http://blah
CONTEXT:  PL/pgSQL function dl_ref(datalink,dl_lco,regclass,name) line 19 at RAISE
PL/pgSQL function dl_ri_trigger() line 38 at assignment
select dlurlcomplete(link), (link)->>'token' is not null as has_token from sample_datalinks2;
     dlurlcomplete      | has_token 
------------------------+-----------
 file:///etc/           | t
 https://www.debian.org | t
(2 rows)

create table sample_datalinks3
    as 
select *
  from sample_datalinks;
NOTICE:  DATALINK DDL: CREATE TRIGGER "~RI_DatalinkTrigger" BEFORE INSERT OR UPDATE OR DELETE ON sample_datalinks3 FOR EACH ROW EXECUTE PROCEDURE datalink.dl_ri_trigger()
select dl_chattr('public','sample_datalinks3','link', dl_lco(link_control=>'FILE'));
ERROR:  Can't change link control options; 6 non-null values present in column "link"
CONTEXT:  PL/pgSQL function dl_chattr(name,name,name,dl_lco) line 22 at RAISE
